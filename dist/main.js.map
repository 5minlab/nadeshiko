{"version":3,"sources":["webpack://nadeshiko/webpack/universalModuleDefinition","webpack://nadeshiko/webpack/bootstrap","webpack://nadeshiko/external \"path\"","webpack://nadeshiko/external \"mz/fs\"","webpack://nadeshiko/./src/sheets/index.ts","webpack://nadeshiko/./src/helpers/index.ts","webpack://nadeshiko/./src/sheets/Attribute.ts","webpack://nadeshiko/external \"js-yaml\"","webpack://nadeshiko/external \"lodash\"","webpack://nadeshiko/./src/sheets/Record.ts","webpack://nadeshiko/./src/index.ts","webpack://nadeshiko/external \"express\"","webpack://nadeshiko/./src/helpers/versions.ts","webpack://nadeshiko/external \"dayjs\"","webpack://nadeshiko/./src/protocols/index.ts","webpack://nadeshiko/external \"yup\"","webpack://nadeshiko/./src/controllers/index.ts","webpack://nadeshiko/./src/commands/fetch.ts","webpack://nadeshiko/(webpack)/buildin/module.js","webpack://nadeshiko/./src/sheets/Sheet.ts","webpack://nadeshiko/./src/sheets/Reference.ts","webpack://nadeshiko/./src/sheets/Constraint.ts","webpack://nadeshiko/./src/sheets/Metadata.ts","webpack://nadeshiko/./src/sheets/Table.ts","webpack://nadeshiko/./src/sheets/Cell.ts","webpack://nadeshiko/./src/helpers/fslib.ts","webpack://nadeshiko/./src/cache/index.ts","webpack://nadeshiko/./src/datasource/gsheet.ts","webpack://nadeshiko/external \"googleapis\""],"names":["root","factory","exports","module","define","amd","global","installedModules","__webpack_require__","moduleId","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","require","__export","AttributeType","attributeList","ty","Integer","prefix","Float","String","Boolean","Date","Raw","Attribute","this","make","length","Error","founds","filter","pair","startsWith","found","replace","cast","v","castInteger","castFloat","castBoolean","castDate","castString","castRaw","x","parseInt","parseFloat","undefined","includes","parseDate","match","hourOffset","year","month","day","hour","minute","second","makeAttributes","row","map","cell","Attribute_1","_","__importStar","Cell_1","INVALID_NUM_ID","INVALID_STR_ID","Record","cells","idcell","obj","forEach","raw","id","getInvalidId","makeRecord","attrs","zip","attr","data","Cell","_this","express_1","__importDefault","helpers_1","P","C","cache_1","gsheet_1","options","auth_inner","router","default","Router","metadataSheetId","redis","dataPath","serviceKey","cache","TableCache","getDataSource","__awaiter","getJWTClient","_a","sent","auth","GSheetDataSource","findVersion","req","body","version","findLatestVersion","_b","post","res","tableSchema","validate","params","table","datasource","syncTable","ok","json","getTable","items","delete","delTable","itemSchema","getRecord","item","getMetadata","metadata","getVersions","versions","getVersionInfo","info","contents","fetchAll","loadAll","tables","path_1","dayjs_1","fs_1","makeVersion","format","findVersions","list","readdir","sort","reverse","isMetadata","findVersionInfo","fp","resolve","metadataList","contentList","yup","shape","string","required","number","min","fetch_1","fslib","sheets_1","loadMetadata","loadTable","dropTable","ds","ref","findReference","fetchSheets","sheet","makeTable","values","saveTable","touchVersion","fetch","findSheetNames","names","tasks","Promise","all","saveMetadata","fetchReferences","fetchConstraints","references","makeReferences","constraints","makeConstraints","Metadata","sheets","dstPath","mkdir","save","webpackPolyfill","deprecate","paths","children","getTableName","split","sanitizeRange","toDataRange","range","makeReference","ConstraintType","makeConstraint","type","firstTable","firstAttribute","secondTable","secondAttribute","ConstraintTable","js_yaml_1","saveItems","filename","text","dump","dst","writeFile","Record_1","Table","firstRow","find","a","slice","readDataFile","dbPath","makeFilePath","readFile","buf","toString","load","console","error","err_1","loadConstraints","loadReferences","_d","apply","_c","concat","makeTableKey","mset","args","flatten","JSON","stringify","hmset","mget","hgetall","val","parse","b","localeCompare","compareRecordId","field","hget","del","curr","endsWith","next","set","versionData","referenceData","constraintData","dropMetadata","googleapis_1","refs","groups","groupBy","keys","sheetId","ranges","google","spreadsheets","batchGet","spreadsheetId","resp","status","statusText","valueRanges","client","JWT","client_email","private_key","reject","authorize","err","tokens"],"mappings":"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","file":"main.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"nadeshiko\"] = factory();\n\telse\n\t\troot[\"nadeshiko\"] = factory();\n})(global, function() {\nreturn "," \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 8);\n","module.exports = require(\"path\");","module.exports = require(\"mz/fs\");","export * from './Sheet';\r\nexport * from './Reference';\r\nexport * from './Constraint';\r\nexport * from './Attribute';\r\nexport * from './Metadata';\r\nexport * from './Table';\r\nexport * from './Record';\r\n","export * from './versions';\r\n","export enum AttributeType {\n\tInteger,\n\tFloat,\n\tString,\n\tBoolean,\n\tDate,\n\tRaw,\n}\n\nconst attributeList: Array<{ ty: AttributeType, prefix: string }> = [\n\t{ ty: AttributeType.Integer, prefix: 'i_' },\n\t{ ty: AttributeType.Float, prefix: 'f_' },\n\t{ ty: AttributeType.String, prefix: 's_' },\n\t{ ty: AttributeType.Boolean, prefix: 'b_' },\n\t{ ty: AttributeType.Date, prefix: 'd_' },\n\t{ ty: AttributeType.Raw, prefix: 'r_' },\n];\n\nexport type AttributeValueType = (\n\tnumber | boolean | Date | string | null | undefined\n);\n\nexport class Attribute {\n\tpublic readonly ty: AttributeType;\n\tpublic readonly name: string;\n\n\tconstructor(ty: AttributeType, name: string) {\n\t\tthis.ty = ty;\n\t\tthis.name = name;\n\t}\n\n\tpublic static make(s: string) {\n\t\tif (!s.length) { throw new Error('blank attribute name'); }\n\t\tconst founds = attributeList.filter((pair) => s.startsWith(pair.prefix));\n\t\tif (founds.length > 0) {\n\t\t\tconst found = founds[0];\n\t\t\treturn new Attribute(found.ty, s.replace(found.prefix, ''));\n\t\t} else {\n\t\t\treturn new Attribute(AttributeType.Raw, s);\n\t\t}\n\t}\n\n\tpublic cast(v: string | undefined) {\n\t\tswitch (this.ty) {\n\t\t\tcase AttributeType.Integer: return castInteger(v);\n\t\t\tcase AttributeType.Float: return castFloat(v);\n\t\t\tcase AttributeType.Boolean: return castBoolean(v);\n\t\t\tcase AttributeType.Date: return castDate(v);\n\t\t\tcase AttributeType.String: return castString(v);\n\t\t\tcase AttributeType.Raw: return castRaw(v);\n\t\t\tdefault: return v;\n\t\t}\n\t}\n}\n\n\nconst castInteger = (x: string | undefined) => {\n\tif (x) {\n\t\treturn parseInt(x, 10);\n\t} else {\n\t\treturn 0;\n\t}\n};\n\nconst castFloat = (x: string | undefined) => {\n\tif (x) {\n\t\treturn parseFloat(x);\n\t} else {\n\t\treturn 0;\n\t}\n};\n\nconst castBoolean = (x: string | undefined) => {\n\tif (x === undefined) { return false; }\n\tif (['TRUE', '1'].includes(x)) { return true; }\n\tif (['FALSE', '0'].includes(x)) { return false; }\n\treturn false;\n};\n\nconst castDate = (x: string | undefined) => {\n\treturn x ? parseDate(x) : null;\n};\n\nconst castRaw = (x: string | undefined) => {\n\treturn x;\n};\n\nconst castString = (x: string | undefined) => {\n\treturn x || '';\n};\n\nconst parseDate = (x: string) => {\n\tconst s = x.replace(/ /g, '');\n\tconst m = s.match(/(\\d{4}).(\\d{1,2}).(\\d{1,2}).+(\\d{2}):(\\d{2}):(\\d{2})/);\n\tif (m) {\n\t\tconst hourOffset = x.includes('오후') ? 12 : 0;\n\t\tconst year = parseInt(m[1], 10);\n\t\tconst month = parseInt(m[2], 10);\n\t\tconst day = parseInt(m[3], 10);\n\t\tconst hour = parseInt(m[4], 10) + hourOffset;\n\t\tconst minute = parseInt(m[5], 10);\n\t\tconst second = parseInt(m[6], 10);\n\t\treturn new Date(year, month - 1, day, hour, minute, second);\n\n\t} else {\n\t\treturn null;\n\t}\n};\n\nexport const makeAttributes = (row: string[]) => row.map((cell) => Attribute.make(cell));\n","module.exports = require(\"js-yaml\");","module.exports = require(\"lodash\");","import { Attribute, AttributeValueType, AttributeType } from './Attribute';\nimport * as _ from 'lodash';\nimport { Cell } from './Cell';\n\nexport const INVALID_NUM_ID = -987654321;\nexport const INVALID_STR_ID = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';\n\nexport interface RecordType {\n\tid: number | string;\n\t[key: string]: AttributeValueType;\n}\n\nexport class Record {\n\tprivate readonly cells: Cell[];\n\tprivate readonly idcell: Cell;\n\n\tconstructor(cells: Cell[]) {\n\t\tthis.cells = cells;\n\t\tthis.idcell = cells.filter((cell) => cell.key === 'id')[0];\n\t}\n\n\tpublic get value() {\n\t\t// id를 제외한 값 채우기\n\t\t// id의 경우 필드 기본값과 다른것을 따라가니까\n\t\tconst obj: { [key: string]: AttributeValueType } = {};\n\t\tthis.cells\n\t\t\t.filter((cell) => cell.key !== 'id')\n\t\t\t.forEach((cell) => {\n\t\t\t\tobj[cell.key] = cell.value;\n\t\t\t});\n\n\t\tif (typeof this.idcell.raw === undefined || this.idcell.raw === '') {\n\t\t\tobj.id = this.getInvalidId();\n\t\t} else {\n\t\t\tobj.id = this.idcell.value;\n\t\t}\n\n\t\tconst record = obj as RecordType;\n\t\treturn record;\n\t}\n\n\tprivate getInvalidId(): number | string {\n\t\tconst idcell = this.idcell;\n\t\tif (idcell) {\n\t\t\tswitch (idcell.ty) {\n\t\t\t\tcase AttributeType.Integer:\n\t\t\t\tcase AttributeType.Float:\n\t\t\t\t\treturn INVALID_NUM_ID;\n\t\t\t\tcase AttributeType.String:\n\t\t\t\t\treturn INVALID_STR_ID;\n\t\t\t\tdefault:\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\treturn INVALID_NUM_ID;\n\t}\n}\n\nexport const makeRecord = (attrs: Attribute[], row: string[]) => {\n\tconst pairs = _.zip(attrs, row).map((pair) => ({\n\t\tattr: pair[0] as Attribute,\n\t\tdata: pair[1] as string,\n\t}));\n\tconst cells = pairs.map((pair) => new Cell(pair.attr, pair.data));\n\treturn new Record(cells);\n};\n","import Redis from 'ioredis';\nimport express from 'express';\nimport { findLatestVersion } from './helpers';\nimport * as P from './protocols';\nimport * as C from './controllers';\nimport { TableCache } from './cache';\nimport {\n\tgetJWTClient,\n\tServiceKey,\n\tGSheetDataSource,\n} from './datasource/gsheet';\nimport { OAuth2Client } from 'googleapis-common';\n\ninterface Options {\n\tmetadataSheetId: string;\n\tredis: Redis.Redis;\n\tdataPath: string;\n\tserviceKey: ServiceKey;\n}\n\nconst nadeshiko = (options: Options) => {\n\tconst router = express.Router();\n\n\tconst {\n\t\tmetadataSheetId,\n\t\tredis,\n\t\tdataPath,\n\t\tserviceKey,\n\t} = options;\n\n\tconst cache = new TableCache(redis);\n\n\tlet auth_inner: OAuth2Client;\n\tconst getAuth = async () => {\n\t\tif (!auth_inner) {\n\t\t\tauth_inner = await getJWTClient(serviceKey);\n\t\t}\n\t\treturn auth_inner;\n\t};\n\n\tconst getDataSource = async () => {\n\t\tconst auth = await getAuth();\n\t\treturn new GSheetDataSource(auth, metadataSheetId);\n\t};\n\n\n\tconst findVersion = async (req: express.Request) => {\n\t\tconst body = req.body ? req.body : {};\n\t\tconst { version } = body;\n\t\treturn version ? version : await findLatestVersion(dataPath);\n\t};\n\n\n\t// table\n\trouter.post('/tables/:table/sync', async (req, res) => {\n\t\tconst { table } = await P.tableSchema.validate(req.params);\n\t\tconst datasource = await getDataSource();\n\t\tconst ok = await C.syncTable(cache, datasource, table);\n\t\tres.json({ ok });\n\t});\n\n\trouter.get('/tables/:table', async (req, res) => {\n\t\tconst { table } = await P.tableSchema.validate(req.params);\n\t\tconst items = await C.getTable(cache, table);\n\t\tres.json({ items });\n\t});\n\n\trouter.delete('/tables/:table', async (req, res) => {\n\t\tconst { table } = await P.tableSchema.validate(req.params);\n\t\tconst ok = await C.delTable(cache, table);\n\t\tres.json({ ok });\n\t});\n\n\t// record\n\trouter.get('/tables/:table/:id', async (req, res) => {\n\t\tconst { table, id } = await P.itemSchema.validate(req.params);\n\t\tconst item = await C.getRecord(cache, table, id);\n\t\tres.json({ item });\n\t});\n\n\t// metadata\n\trouter.get('/metadata', async (req, res) => {\n\t\tconst metadata = await C.getMetadata(cache);\n\t\tres.json(metadata);\n\t});\n\n\t// version\n\trouter.get('/versions/', async (req, res) => {\n\t\tconst versions = await C.getVersions(dataPath);\n\t\tres.json(versions);\n\t});\n\n\trouter.get('/versions/:version', async (req, res) => {\n\t\tconst version: string = req.params.version;\n\t\tconst info = await C.getVersionInfo(dataPath, version);\n\t\tres.json({\n\t\t\tversion,\n\t\t\tmetadata: info.metadata,\n\t\t\tcontents: info.contents,\n\t\t});\n\t});\n\n\t// commands\n\trouter.post('/commands/fetch', async (req, res) => {\n\t\tconst datasource = await getDataSource();\n\t\tconst { version, metadata } = await C.fetchAll(datasource, dataPath);\n\t\tres.json({\n\t\t\tversion,\n\t\t\tmetadata,\n\t\t});\n\t});\n\n\trouter.post('/commands/load', async (req, res) => {\n\t\tconst version = await findVersion(req);\n\t\tconst { tables, metadata } = await C.loadAll(cache, dataPath, version);\n\t\tres.json({\n\t\t\tversion,\n\t\t\ttables,\n\t\t\tmetadata,\n\t\t});\n\t});\n\n\treturn router;\n};\nexport = nadeshiko;\n","module.exports = require(\"express\");","import path from 'path';\nimport dayjs from 'dayjs';\nimport fs from 'mz/fs';\n\nexport const makeVersion = (d: Date) => {\n\tconst day = dayjs(d);\n\treturn day.format('YYYYMMDD-HHmmss');\n};\n\nexport const findLatestVersion = async (dataPath: string) => {\n\tconst list = await findVersions(dataPath);\n\tconst first: string | undefined = list[0];\n\treturn first;\n};\n\nexport const findVersions = async (dataPath: string) => {\n\tconst list = (await fs.readdir(dataPath)).sort().reverse();\n\treturn list;\n};\n\nconst isMetadata = (x: string) => x.startsWith('metadata-');\n\nexport const findVersionInfo = async (dataPath: string, version: string) => {\n\tconst fp = path.resolve(dataPath, version);\n\tconst list = (await fs.readdir(fp)).sort().reverse().map((x) => x.replace('.yaml', ''));\n\tconst metadataList = list.filter((x) => isMetadata(x));\n\tconst contentList = list.filter((x) => !isMetadata(x));\n\treturn {\n\t\tmetadata: metadataList,\n\t\tcontents: contentList,\n\t};\n};\n","module.exports = require(\"dayjs\");","import * as yup from 'yup';\r\n\r\ninterface TableReq {\r\n\ttable: string;\r\n}\r\n\r\nexport const tableSchema = yup.object().shape<TableReq>({\r\n\ttable: yup.string().required(),\r\n});\r\n\r\ninterface ItemReq {\r\n\ttable: string;\r\n\tid: number;\r\n}\r\n\r\nexport const itemSchema = yup.object().shape<ItemReq>({\r\n\ttable: yup.string().required(),\r\n\tid: yup.number().min(0).required(),\r\n});\r\n","module.exports = require(\"yup\");","import { fetch } from '../commands/fetch';\nimport * as fslib from '../helpers/fslib';\nimport { TableCache } from '../cache';\nimport { DataSource } from '../datasource';\nimport { makeTable } from '../sheets';\nimport { findVersions, findVersionInfo } from '../helpers';\n\nexport const getMetadata = async (cache: TableCache) => {\n\tconst metadata = await cache.loadMetadata();\n\treturn metadata;\n};\n\nexport const getTable = async (cache: TableCache, name: string) => {\n\tconst table = await cache.loadTable(name);\n\tif (table.length) {\n\t\treturn table;\n\t} else {\n\t\tthrow new Error('table not found');\n\t}\n};\n\nexport const delTable = async (cache: TableCache, name: string) => {\n\tconst result = await cache.dropTable(name);\n\tif (result) {\n\t\treturn true;\n\t} else {\n\t\tthrow new Error('no table deleted');\n\t}\n};\n\nexport const getRecord = async (cache: TableCache, name: string, id: number) => {\n\tconst item = await cache.get(name, id);\n\tif (item) {\n\t\treturn item;\n\t} else {\n\t\tthrow new Error('record not found');\n\t}\n};\n\nexport const syncTable = async (\n\tcache: TableCache,\n\tds: DataSource,\n\tname: string,\n) => {\n\tconst metadata = await cache.loadMetadata();\n\tconst ref = metadata.findReference(name);\n\tif (!ref) { throw new Error('reference not found'); }\n\n\tconst founds = await ds.fetchSheets([ref]);\n\tif (founds.length === 0) { throw new Error('sheet not found'); }\n\n\tconst found = founds[0];\n\tconst sheet = makeTable(found.name, found.values);\n\tawait cache.saveTable(sheet);\n\tawait cache.touchVersion();\n\treturn true;\n};\n\nexport const fetchAll = async (\n\tdatasource: DataSource,\n\tdataPath: string,\n) => {\n\t// TODO fetch를 권한 요청 없이 처리하는 방법?\n\tconst { version, metadata } = await fetch(datasource, dataPath);\n\treturn {\n\t\tversion,\n\t\tmetadata,\n\t};\n};\n\nexport const loadAll = async (\n\tcache: TableCache,\n\tdataPath: string,\n\tversion: string,\n) => {\n\tconst names = await fslib.findSheetNames(dataPath, version);\n\tconst tasks = names.map(async (name) => {\n\t\tconst table = await fslib.loadTable(dataPath, version, name);\n\t\tawait cache.saveTable(table);\n\t});\n\tawait Promise.all(tasks);\n\n\tconst metadata = await fslib.loadMetadata(dataPath, version);\n\tawait cache.saveMetadata(metadata);\n\n\treturn {\n\t\ttables: names,\n\t\tmetadata,\n\t};\n};\n\nexport const getVersions = async (dataPath: string) => {\n\tconst versions = await findVersions(dataPath);\n\treturn versions;\n};\n\nexport const getVersionInfo = async (dataPath: string, version: string) => {\n\tconst info = await findVersionInfo(dataPath, version);\n\treturn info;\n};\n","import fs from 'mz/fs';\nimport path from 'path';\nimport * as _ from 'lodash';\nimport { makeVersion } from '../helpers';\nimport { DataSource } from '../datasource';\nimport {\n\tmakeReferences,\n\tmakeConstraints,\n\tMetadata,\n\tmakeTable,\n} from '../sheets';\n\n\nexport const fetch = async (\n\tds: DataSource,\n\tdataPath: string,\n) => {\n\tconst version = makeVersion(new Date());\n\n\tconst metadataList = await Promise.all([\n\t\tds.fetchReferences(),\n\t\tds.fetchConstraints(),\n\t]);\n\tconst references = makeReferences(metadataList[0]);\n\tconst constraints = makeConstraints(metadataList[1]);\n\tconst metadata = new Metadata(version, references, constraints);\n\n\tconst sheets = await ds.fetchSheets(references);\n\tconst tables = sheets.map((sheet) => {\n\t\treturn makeTable(sheet.name, sheet.values);\n\t});\n\n\tconst dstPath = path.resolve(dataPath, version);\n\tawait fs.mkdir(dstPath);\n\n\tawait metadata.save(dstPath);\n\tconst tasks = tables.map((table) => {\n\t\ttable.save(dstPath);\n\t});\n\tawait Promise.all(tasks);\n\n\treturn {\n\t\tversion,\n\t\tmetadata,\n\t};\n};\n\nconst main = async () => {\n\t// try {\n\t// \tawait fetch(...);\n\t// } catch (err) {\n\t// \tconsole.error(err);\n\t// }\n};\n\nif (require.main === module) {\n\tmain();\n}\n","module.exports = function(module) {\n\tif (!module.webpackPolyfill) {\n\t\tmodule.deprecate = function() {};\n\t\tmodule.paths = [];\n\t\t// module.parent = undefined by default\n\t\tif (!module.children) module.children = [];\n\t\tObject.defineProperty(module, \"loaded\", {\n\t\t\tenumerable: true,\n\t\t\tget: function() {\n\t\t\t\treturn module.l;\n\t\t\t}\n\t\t});\n\t\tObject.defineProperty(module, \"id\", {\n\t\t\tenumerable: true,\n\t\t\tget: function() {\n\t\t\t\treturn module.i;\n\t\t\t}\n\t\t});\n\t\tmodule.webpackPolyfill = 1;\n\t}\n\treturn module;\n};\n","export const getTableName = (r: string) => r.split('!')[0];\r\nexport const sanitizeRange = (r: string) => r.replace(/'/g, '');\r\n\r\nexport interface Sheet {\r\n\tname: string;\r\n\tvalues: string[][];\r\n}\r\n","export interface Reference {\r\n\ttable: string;\r\n\trange: string;\r\n\tsheet: string;\r\n}\r\n\r\nexport const toDataRange = (ref: Reference) => {\r\n\treturn `${ref.table}!${ref.range}`;\r\n};\r\n\r\nexport const makeReference = (row: string[]): Reference => {\r\n\treturn {\r\n\t\ttable: row[0],\r\n\t\trange: row[1],\r\n\t\tsheet: row[2],\r\n\t};\r\n};\r\n\r\nexport const makeReferences = (values: string[][]) => {\r\n\treturn values.map((row) => makeReference(row));\r\n};\r\n\r\n","export enum ConstraintType {\r\n\tForeignKey = 'fk',\r\n\tUnique = 'unique',\r\n}\r\n\r\nexport interface Constraint {\r\n\ttype: ConstraintType;\r\n\tfirstTable: string;\r\n\tfirstAttribute: string;\r\n\tsecondTable: string;\r\n\tsecondAttribute: string;\r\n}\r\n\r\nexport const makeConstraint = (row: string[]): Constraint => {\r\n\t// TODO check type value\r\n\treturn {\r\n\t\ttype: row[0] as ConstraintType,\r\n\t\tfirstTable: row[1],\r\n\t\tfirstAttribute: row[2],\r\n\t\tsecondTable: row[3],\r\n\t\tsecondAttribute: row[4],\r\n\t};\r\n};\r\n\r\nexport const makeConstraints = (values: string[][]): Constraint[] => {\r\n\treturn values.map((row) => makeConstraint(row));\r\n};\r\n\r\nexport class ConstraintTable {\r\n\tprivate readonly constraints: Constraint[];\r\n\r\n\tconstructor(constraints: Constraint[]) {\r\n\t\tthis.constraints = constraints;\r\n\t}\r\n}\r\n","import fs from 'mz/fs';\nimport path from 'path';\nimport yaml from 'js-yaml';\nimport { Constraint } from './Constraint';\nimport { Reference } from './Reference';\n\nexport class Metadata {\n\tpublic readonly version: string;\n\tpublic readonly references: Reference[];\n\tpublic readonly constraints: Constraint[];\n\n\tconstructor(\n\t\tversion: string,\n\t\treferences: Reference[],\n\t\tconstraints: Constraint[],\n\t) {\n\t\tthis.version = version;\n\t\tthis.references = references;\n\t\tthis.constraints = constraints;\n\t}\n\n\tpublic async save(dataPath: string) {\n\t\treturn Promise.all([\n\t\t\tthis.saveItems(dataPath, `metadata-references.yaml`, this.references),\n\t\t\tthis.saveItems(dataPath, `metadata-constraints.yaml`, this.constraints),\n\t\t]);\n\t}\n\n\tprivate async saveItems<T>(dataPath: string, filename: string, items: T[]) {\n\t\tconst text = yaml.dump(items);\n\t\tconst dst = path.resolve(dataPath, filename);\n\t\tawait fs.writeFile(dst, text);\n\t}\n\n\tpublic findReference(table: string) {\n\t\tconst founds = this.references.filter((x) => x.table === table);\n\t\treturn founds.length ? founds[0] : undefined;\n\t}\n}\n\n\n","import fs from 'mz/fs';\nimport path from 'path';\nimport yaml from 'js-yaml';\nimport { RecordType, makeRecord } from './Record';\nimport { makeAttributes } from './Attribute';\n\nexport class Table<T extends RecordType> {\n\tpublic readonly name: string;\n\tpublic readonly items: T[];\n\n\tconstructor(name: string, items: T[]) {\n\t\tthis.name = name;\n\t\tthis.items = items;\n\t}\n\n\tpublic async save(dataPath: string) {\n\t\tconst text = yaml.dump(this.items);\n\t\tconst filename = `${this.name}.yaml`;\n\t\tconst dst = path.resolve(dataPath, filename);\n\t\tawait fs.writeFile(dst, text);\n\t}\n\n\tpublic get length() { return this.items.length; }\n}\n\n\nexport const makeTable = (name: string, values: string[][]) => {\n\tconst firstRow = values[0];\n\tconst attrs = makeAttributes(firstRow);\n\n\tconst idattr = attrs.find((a) => a.name === 'id');\n\tif (!idattr) { throw new Error('id attribute not found'); }\n\n\tconst records = values.slice(1).map((row) => makeRecord(attrs, row));\n\tconst items = records.map((r) => r.value);\n\n\treturn new Table(name, items);\n};\n","import { Attribute } from './Attribute';\n\nexport class Cell {\n\tprivate readonly attr: Attribute;\n\tprivate readonly data: string;\n\n\tconstructor(attr: Attribute, data: string) {\n\t\tthis.attr = attr;\n\t\tthis.data = data;\n\t}\n\n\tpublic get value() { return this.attr.cast(this.data); }\n\tpublic get key() { return this.attr.name; }\n\tpublic get ty() { return this.attr.ty; }\n\tpublic get raw() { return this.data; }\n}\n","import fs from 'mz/fs';\nimport path from 'path';\nimport yaml from 'js-yaml';\nimport { RecordType, Table, Constraint, Reference, Metadata } from '../sheets';\n\nconst makeFilePath = (dataPath: string, version: string, filename: string) => {\n\tconst dbPath = path.resolve(dataPath, version);\n\treturn path.resolve(dbPath, filename);\n};\n\n\nconst readDataFile = async (dataPath: string, version: string, filename: string) => {\n\tconst fp = makeFilePath(dataPath, version, filename);\n\tconst buf = await fs.readFile(fp);\n\tconst text = buf.toString('utf8');\n\tconst content = yaml.load(text);\n\treturn content;\n};\n\n\nexport const findSheetNames = async (dataPath: string, version: string) => {\n\tconst dbPath = path.resolve(dataPath, version);\n\tconst list = (await fs.readdir(dbPath))\n\t\t.sort()\n\t\t.filter((x) => x.includes('.yaml'))\n\t\t.filter((x) => !x.startsWith('metadata-'))\n\t\t.map((x) => x.replace('.yaml', ''));\n\treturn list;\n};\n\nexport const loadTable = async <T extends RecordType>(dataPath: string, version: string, name: string) => {\n\tif (name.startsWith('metadata-')) {\n\t\treturn new Table(name, []);\n\t}\n\n\ttry {\n\t\tconst filename = `${name}.yaml`;\n\t\tconst items = await readDataFile(dataPath, version, filename) as T[];\n\t\treturn new Table(name, items);\n\n\t} catch (err) {\n\t\tconsole.error(err);\n\t\treturn new Table(name, []);\n\t}\n};\n\n\nexport const loadMetadata = async (dataPath: string, version: string) => {\n\tconst loadConstraints = async () => {\n\t\tconst filename = `metadata-constraints.yaml`;\n\t\tconst items = await readDataFile(dataPath, version, filename) as Constraint[];\n\t\treturn items;\n\t};\n\n\tconst loadReferences = async () => {\n\t\tconst filename = `metadata-references.yaml`;\n\t\tconst items = await readDataFile(dataPath, version, filename) as Reference[];\n\t\treturn items;\n\t};\n\n\tconst data = await Promise.all([\n\t\tawait loadReferences(),\n\t\tawait loadConstraints(),\n\t]);\n\n\treturn new Metadata(version, ...data);\n};\n","import Redis from 'ioredis';\nimport { RecordType, Table, Metadata, Reference, Constraint } from '../sheets';\nimport * as _ from 'lodash';\n\nconst makeTableKey = (table: string) => {\n\tconst key = `nadeshiko:${table}`;\n\treturn key;\n};\n\nconst makeConstraintsKey = () => {\n\tconst key = `nadeshiko:constraints`;\n\treturn key;\n};\n\nconst makeReferencesKey = () => {\n\tconst key = `nadeshiko:references`;\n\treturn key;\n};\n\nconst makeVersionKey = () => {\n\tconst key = `nadeshiko:version`;\n\treturn key;\n};\n\nconst compareRecordId = <T extends RecordType>(a: T, b: T) => {\n\tif (typeof a.id === 'number' && typeof b.id === 'number') {\n\t\treturn a.id - b.id;\n\t} else if (typeof a.id === 'string' && typeof b.id === 'string') {\n\t\treturn a.id.localeCompare(b.id);\n\t}\n\tthrow new Error(`invalid format: compare ${typeof a.id} and ${typeof b.id}`);\n};\n\nexport class TableCache {\n\tprivate readonly redis: Redis.Redis;\n\n\tconstructor(redis: Redis.Redis) {\n\t\tthis.redis = redis;\n\t}\n\n\tpublic async mset<T extends RecordType>(name: string, items: T[]) {\n\t\tif (items.length === 0) { return; }\n\t\tconst key = makeTableKey(name);\n\t\tconst args = _.flatten(items.map((item) => [\n\t\t\titem.id.toString(),\n\t\t\tJSON.stringify(item),\n\t\t]));\n\t\t// hmset 할때 배열을 풀어서 넣지 않으면\n\t\t// ioredis의 결과과 ioredis-mock의 결과가 달라진다\n\t\tawait this.redis.hmset(key, ...args);\n\t}\n\n\tpublic async mget<T extends RecordType>(name: string) {\n\t\tconst key = makeTableKey(name);\n\t\tconst founds: { [key: string]: string } = await this.redis.hgetall(key);\n\t\tconst values = _.values(founds);\n\t\tconst items = values.map((data) => {\n\t\t\tconst val = JSON.parse(data) as T;\n\t\t\treturn { val };\n\t\t});\n\t\treturn items.sort((a, b) => compareRecordId(a.val, b.val))\n\t\t\t.map((item) => item.val);\n\t}\n\n\tpublic async get<T extends RecordType>(name: string, id: number | string) {\n\t\tconst key = makeTableKey(name);\n\t\tconst field = id.toString();\n\t\tconst found = await this.redis.hget(key, field);\n\t\treturn found ? JSON.parse(found) as T : undefined;\n\t}\n\n\tpublic async saveTable<T extends RecordType>(table: Table<T>) {\n\t\tconst name = table.name;\n\t\tconst items = table.items;\n\n\t\tconst key = makeTableKey(name);\n\t\tawait this.redis.del(key);\n\t\tawait this.mset(name, items);\n\t}\n\n\tpublic async loadTable<T extends RecordType>(name: string) {\n\t\tconst items = await this.mget<T>(name);\n\t\treturn new Table(name, items);\n\t}\n\n\tpublic async dropTable(name: string) {\n\t\tconst key = makeTableKey(name);\n\t\tconst result = await this.redis.del(key);\n\t\treturn result ? true : false;\n\t}\n\n\tpublic async saveMetadata(metadata: Metadata) {\n\t\tawait this.redis.mset(\n\t\t\tmakeVersionKey(),\n\t\t\tmetadata.version,\n\t\t\tmakeReferencesKey(),\n\t\t\tJSON.stringify(metadata.references),\n\t\t\tmakeConstraintsKey(),\n\t\t\tJSON.stringify(metadata.constraints),\n\t\t);\n\t}\n\n\tpublic async touchVersion() {\n\t\tconst key = makeVersionKey();\n\t\tconst curr = await this.redis.get(key);\n\t\tif (curr) {\n\t\t\tif (!curr.endsWith('-dirty')) {\n\t\t\t\tconst next = curr + '-dirty';\n\t\t\t\tawait this.redis.set(key, next);\n\t\t\t}\n\t\t}\n\t}\n\n\tpublic async loadMetadata() {\n\t\tconst versionData = await this.redis.get(makeVersionKey());\n\t\tconst referenceData = await this.redis.get(makeReferencesKey());\n\t\tconst constraintData = await this.redis.get(makeConstraintsKey());\n\t\tif (!versionData || !referenceData || !constraintData) {\n\t\t\treturn new Metadata('NULL', [], []);\n\t\t}\n\n\t\tconst references = JSON.parse(referenceData) as Reference[];\n\t\tconst constraints = JSON.parse(constraintData) as Constraint[];\n\t\treturn new Metadata(versionData, references, constraints);\n\t}\n\n\tpublic async dropMetadata() {\n\t\tawait this.redis.del(\n\t\t\tmakeVersionKey(),\n\t\t\tmakeReferencesKey(),\n\t\t\tmakeConstraintsKey(),\n\t\t);\n\t}\n}\n","import { google } from 'googleapis';\r\nimport {\r\n\tsanitizeRange,\r\n\tgetTableName,\r\n\tReference,\r\n\ttoDataRange,\r\n\tSheet,\r\n} from '../sheets';\r\nimport { OAuth2Client } from 'googleapis-common';\r\nimport * as _ from 'lodash';\r\nimport { DataSource } from './base';\r\n\r\nexport class GSheetDataSource implements DataSource {\r\n\tprivate readonly auth: OAuth2Client;\r\n\tprivate readonly metadataSheetId: string;\r\n\r\n\tconstructor(auth: OAuth2Client, metadataSheetId: string) {\r\n\t\tthis.auth = auth;\r\n\t\tthis.metadataSheetId = metadataSheetId;\r\n\t}\r\n\r\n\tpublic async fetchReferences(): Promise<string[][]> {\r\n\t\tconst ref: Reference = {\r\n\t\t\ttable: 'metadata-references',\r\n\t\t\trange: 'A2:C',\r\n\t\t\tsheet: this.metadataSheetId,\r\n\t\t};\r\n\t\tconst founds = await this.fetchSheets([ref]);\r\n\t\treturn founds[0].values;\r\n\t}\r\n\r\n\tpublic async fetchConstraints(): Promise<string[][]> {\r\n\t\tconst ref: Reference = {\r\n\t\t\ttable: 'metadata-constraints',\r\n\t\t\trange: 'A2:E',\r\n\t\t\tsheet: this.metadataSheetId,\r\n\t\t};\r\n\t\tconst founds = await this.fetchSheets([ref]);\r\n\t\treturn founds[0].values;\r\n\t}\r\n\r\n\tpublic async fetchSheets(refs: Reference[]): Promise<Sheet[]> {\r\n\t\tconst groups = _.groupBy(refs, (x: Reference) => x.table);\r\n\t\tconst keys = _.keys(groups);\r\n\t\tconst tasks = keys.map(async (key) => {\r\n\t\t\tconst refs = groups[key];\r\n\t\t\tconst sheetId = refs[0].sheet;\r\n\t\t\tconst founds = await this.fetch(sheetId, refs);\r\n\t\t\treturn founds;\r\n\t\t});\r\n\t\tconst founds = _.flatten(await Promise.all(tasks));\r\n\t\treturn founds;\r\n\t}\r\n\r\n\tprivate async fetch(sheetId: string, refs: Reference[]) {\r\n\t\tconst ranges = refs.map((r) => toDataRange(r));\r\n\t\tconst sheets = google.sheets({ version: 'v4', auth: this.auth });\r\n\t\tconst resp = await sheets.spreadsheets.values.batchGet({\r\n\t\t\tspreadsheetId: sheetId,\r\n\t\t\tranges,\r\n\t\t});\r\n\t\tif (resp.status !== 200) { throw new Error(`batchGet failed: ${resp.statusText}`); }\r\n\t\tif (!resp.data.valueRanges) { throw new Error(`no values found`); }\r\n\r\n\t\tconst founds = resp.data.valueRanges.map((found) => {\r\n\t\t\tconst range = sanitizeRange(found.range!);\r\n\t\t\tconst name = getTableName(range);\r\n\t\t\tconst values = found.values!;\r\n\t\t\treturn { name, values };\r\n\t\t});\r\n\t\treturn founds;\r\n\t}\r\n}\r\n\r\n\r\nexport interface ServiceKey {\r\n\t// type: string;\r\n\t// project_id: string;\r\n\t// private_key_id: string;\r\n\tprivate_key: string;\r\n\tclient_email: string;\r\n\t// client_id: string;\r\n\t// auth_uri: string;\r\n\t// token_uri: string;\r\n\t// auth_provider_x509_cert_url: string;\r\n\t// client_x509_cert_url: string;\r\n}\r\n\r\nexport const getJWTClient = async (serviceKey: ServiceKey): Promise<OAuth2Client> => {\r\n\t// http://isd-soft.com/tech_blog/accessing-google-apis-using-service-account-node-js/\r\n\tconst client = new google.auth.JWT(\r\n\t\tserviceKey.client_email,\r\n\t\tundefined,\r\n\t\tserviceKey.private_key,\r\n\t\t['https://www.googleapis.com/auth/spreadsheets'],\r\n\t);\r\n\treturn new Promise((resolve, reject) => {\r\n\t\tclient.authorize((err, tokens) => {\r\n\t\t\tif (err) { reject(err); }\r\n\t\t\telse { resolve(client); }\r\n\t\t});\r\n\t});\r\n};\r\n","module.exports = require(\"googleapis\");"],"sourceRoot":""}