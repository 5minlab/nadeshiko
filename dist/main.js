!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.nadeshiko=t():e.nadeshiko=t()}(global,function(){return function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=8)}([function(e,t){e.exports=require("mz/fs")},function(e,t,n){"use strict";function r(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),r(n(17)),r(n(18)),r(n(19)),r(n(6)),r(n(20)),r(n(21)),r(n(7))},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("js-yaml")},function(e,t){e.exports=require("lodash")},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}(n(10))},function(e,t,n){"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.Integer=0]="Integer",e[e.Float=1]="Float",e[e.String=2]="String",e[e.Boolean=3]="Boolean",e[e.Date=4]="Date"}(r=t.AttributeType||(t.AttributeType={}));var a=function(){function e(e,t){this.ty=e,this.name=t}return e.make=function(t){for(var n=0,a=[[r.Integer,"i_"],[r.Float,"f_"],[r.String,"s_"],[r.Boolean,"b_"],[r.Date,"d_"]];n<a.length;n++){var i=a[n],o=i[1];if(t.startsWith(o))return new e(i[0],t.replace(o,""))}throw new Error("cannot make attribute: "+t)},e.prototype.cast=function(e){switch(this.ty){case r.Integer:return i(e);case r.Float:return o(e);case r.Boolean:return u(e);case r.Date:return s(e);case r.String:return e||"";default:return e}},e}();t.Attribute=a;var i=function(e){return e?parseInt(e,10):0},o=function(e){return e?parseFloat(e):0},u=function(e){return void 0!==e&&(!!["TRUE","1"].includes(e)||(["FALSE","0"].includes(e),!1))},s=function(e){return e?c(e):null},c=function(e){var t=e.replace(/ /g,"").match(/(\d{4}).(\d{1,2}).(\d{1,2}).+(\d{2}):(\d{2}):(\d{2})/);if(t){var n=e.includes("오후")?12:0,r=parseInt(t[1],10),a=parseInt(t[2],10),i=parseInt(t[3],10),o=parseInt(t[4],10)+n,u=parseInt(t[5],10),s=parseInt(t[6],10);return new Date(r,a-1,i,o,u,s)}return null};t.makeAttributes=function(e){return e.map(function(e){return a.make(e)})}},function(e,t,n){"use strict";var r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});var a=r(n(4)),i=n(22),o=function(){function e(e){this.cells=e}return Object.defineProperty(e.prototype,"value",{get:function(){var e={id:-987654321};return this.cells.forEach(function(t){e[t.key]=t.value}),e},enumerable:!0,configurable:!0}),e}();t.Record=o,t.makeRecord=function(e,t){var n=a.zip(e,t).map(function(e){return{attr:e[0],data:e[1]}}).map(function(e){return new i.Cell(e.attr,e.data)});return new o(n)}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(a,i){function o(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){e.done?a(e.value):new n(function(t){t(e.value)}).then(o,u)}s((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},u=this;Object.defineProperty(t,"__esModule",{value:!0});var s=i(n(9)),c=n(5),l=o(n(12)),f=o(n(14)),h=n(24),d=n(25);t.default=function(e){var t,n=s.default.Router(),i=e.metadataSheetId,o=e.redis,p=e.dataPath,v=e.serviceKey,b=new h.TableCache(o),y=function(){return r(u,void 0,void 0,function(){var e;return a(this,function(n){switch(n.label){case 0:return[4,r(u,void 0,void 0,function(){return a(this,function(e){switch(e.label){case 0:return t?[3,2]:[4,d.getJWTClient(v)];case 1:t=e.sent(),e.label=2;case 2:return[2,t]}})})];case 1:return e=n.sent(),[2,new d.GSheetDataSource(e,i)]}})})},w=function(e){return r(u,void 0,void 0,function(){var t,n,r;return a(this,function(a){switch(a.label){case 0:return t=e.body?e.body:{},(n=t.version)?(r=n,[3,3]):[3,1];case 1:return[4,c.findLatestVersion(p)];case 2:r=a.sent(),a.label=3;case 3:return[2,r]}})})};return n.post("/tables/:table/sync",function(e,t){return r(u,void 0,void 0,function(){var n,r,i;return a(this,function(a){switch(a.label){case 0:return[4,l.tableSchema.validate(e.params)];case 1:return n=a.sent().table,[4,y()];case 2:return r=a.sent(),[4,f.syncTable(b,r,n)];case 3:return i=a.sent(),t.json({ok:i}),[2]}})})}),n.get("/tables/:table",function(e,t){return r(u,void 0,void 0,function(){var n,r;return a(this,function(a){switch(a.label){case 0:return[4,l.tableSchema.validate(e.params)];case 1:return n=a.sent().table,[4,f.getTable(b,n)];case 2:return r=a.sent(),t.json({items:r}),[2]}})})}),n.get("/tables/:table/:id",function(e,t){return r(u,void 0,void 0,function(){var n,r,i,o;return a(this,function(a){switch(a.label){case 0:return[4,l.itemSchema.validate(e.params)];case 1:return n=a.sent(),r=n.table,i=n.id,[4,f.getRecord(b,r,i)];case 2:return o=a.sent(),t.json({item:o}),[2]}})})}),n.get("/metadata",function(e,t){return r(u,void 0,void 0,function(){var e;return a(this,function(n){switch(n.label){case 0:return[4,f.getMetadata(b)];case 1:return e=n.sent(),t.json(e),[2]}})})}),n.post("/commands/fetch",function(e,t){return r(u,void 0,void 0,function(){var e,n,r,i;return a(this,function(a){switch(a.label){case 0:return[4,y()];case 1:return e=a.sent(),[4,f.fetchAll(e,p)];case 2:return n=a.sent(),r=n.version,i=n.metadata,t.json({version:r,metadata:i}),[2]}})})}),n.post("/commands/load",function(e,t){return r(u,void 0,void 0,function(){var n,r,i,o;return a(this,function(a){switch(a.label){case 0:return[4,w(e)];case 1:return n=a.sent(),[4,f.loadAll(b,p,n)];case 2:return r=a.sent(),i=r.tables,o=r.metadata,t.json({version:n,tables:i,metadata:o}),[2]}})})}),n}},function(e,t){e.exports=require("express")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(a,i){function o(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){e.done?a(e.value):new n(function(t){t(e.value)}).then(o,u)}s((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},o=this;Object.defineProperty(t,"__esModule",{value:!0});var u=i(n(11)),s=i(n(0));t.makeVersion=function(e){return u.default(e).format("YYYYMMDD-HHmmss")},t.findLatestVersion=function(e){return r(o,void 0,void 0,function(){var t;return a(this,function(n){switch(n.label){case 0:return[4,s.default.readdir(e)];case 1:return t=n.sent().sort().reverse(),[2,t[0]]}})})}},function(e,t){e.exports=require("dayjs")},function(e,t,n){"use strict";var r=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});var a=r(n(13));t.tableSchema=a.object().shape({table:a.string().required()}),t.itemSchema=a.object().shape({table:a.string().required(),id:a.number().min(0).required()})},function(e,t){e.exports=require("yup")},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(a,i){function o(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){e.done?a(e.value):new n(function(t){t(e.value)}).then(o,u)}s((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},o=this;Object.defineProperty(t,"__esModule",{value:!0});var u=n(15),s=i(n(23)),c=n(1);t.getMetadata=function(e){return r(o,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,e.loadMetadata()];case 1:return[2,t.sent()]}})})},t.getTable=function(e,t){return r(o,void 0,void 0,function(){var n;return a(this,function(r){switch(r.label){case 0:return[4,e.loadTable(t)];case 1:if((n=r.sent()).length)return[2,n];throw new Error("table not found")}})})},t.getRecord=function(e,t,n){return r(o,void 0,void 0,function(){var r;return a(this,function(a){switch(a.label){case 0:return[4,e.get(t,n)];case 1:if(r=a.sent())return[2,r];throw new Error("record not found")}})})},t.syncTable=function(e,t,n){return r(o,void 0,void 0,function(){var r,i,o,u,s;return a(this,function(a){switch(a.label){case 0:return[4,e.loadMetadata()];case 1:if(r=a.sent(),!(i=r.findReference(n)))throw new Error("reference not found");return[4,t.fetchSheets([i])];case 2:if(0===(o=a.sent()).length)throw new Error("sheet not found");return u=o[0],s=c.makeTable(u.name,u.values),[4,e.saveTable(s)];case 3:return a.sent(),[2,!0]}})})},t.fetchAll=function(e,t){return r(o,void 0,void 0,function(){var n,r,i;return a(this,function(a){switch(a.label){case 0:return[4,u.fetch(e,t)];case 1:return n=a.sent(),r=n.version,i=n.metadata,[2,{version:r,metadata:i}]}})})},t.loadAll=function(e,t,n){return r(o,void 0,void 0,function(){var i,o,u,c=this;return a(this,function(l){switch(l.label){case 0:return[4,s.findSheetNames(t,n)];case 1:return i=l.sent(),o=i.map(function(i){return r(c,void 0,void 0,function(){var r;return a(this,function(a){switch(a.label){case 0:return[4,s.loadTable(t,n,i)];case 1:return r=a.sent(),[4,e.saveTable(r)];case 2:return a.sent(),[2]}})})}),[4,Promise.all(o)];case 2:return l.sent(),[4,s.loadMetadata(t,n)];case 3:return u=l.sent(),[4,e.saveMetadata(u)];case 4:return l.sent(),[2,{tables:i,metadata:u}]}})})}},function(e,t,n){"use strict";(function(e){var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(a,i){function o(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){e.done?a(e.value):new n(function(t){t(e.value)}).then(o,u)}s((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},o=this;Object.defineProperty(t,"__esModule",{value:!0});var u=i(n(0)),s=i(n(2)),c=n(5),l=n(1);t.fetch=function(e,t){return r(o,void 0,void 0,function(){var n,r,i,o,f,h,d,p,v;return a(this,function(a){switch(a.label){case 0:return[4,Promise.all([e.fetchReferences(),e.fetchConstraints()])];case 1:return n=a.sent(),r=l.makeReferences(n[0]),i=l.makeConstraints(n[1]),o=new l.Metadata(r,i),[4,e.fetchSheets(r)];case 2:return f=a.sent(),h=f.map(function(e){return l.makeTable(e.name,e.values)}),d=c.makeVersion(new Date),p=s.default.resolve(t,d),[4,u.default.mkdir(p)];case 3:return a.sent(),[4,o.save(p)];case 4:return a.sent(),v=h.map(function(e){e.save(p)}),[4,Promise.all(v)];case 5:return a.sent(),[2,{version:d,metadata:o}]}})})};n.c[n.s]===e&&r(o,void 0,void 0,function(){return a(this,function(e){return[2]})})}).call(this,n(16)(e))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.getTableName=function(e){return e.split("!")[0]},t.sanitizeRange=function(e){return e.replace(/'/g,"")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.toDataRange=function(e){return e.table+"!"+e.range},t.makeReference=function(e){return{table:e[0],range:e[1],sheet:e[2]}},t.makeReferences=function(e){return e.map(function(e){return t.makeReference(e)})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.ForeignKey="fk",e.Unique="unique"}(t.ConstraintType||(t.ConstraintType={})),t.makeConstraint=function(e){return{type:e[0],firstTable:e[1],firstAttribute:e[2],secondTable:e[3],secondAttribute:e[4]}},t.makeConstraints=function(e){return e.map(function(e){return t.makeConstraint(e)})};var r=function(){return function(e){this.constraints=e}}();t.ConstraintTable=r},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(a,i){function o(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){e.done?a(e.value):new n(function(t){t(e.value)}).then(o,u)}s((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=i(n(0)),u=i(n(2)),s=i(n(3)),c=function(){function e(e,t){this.references=e,this.constraints=t}return e.prototype.save=function(e){return r(this,void 0,void 0,function(){return a(this,function(t){return[2,Promise.all([this.saveItems(e,"metadata-references.yaml",this.references),this.saveItems(e,"metadata-constraints.yaml",this.constraints)])]})})},e.prototype.saveItems=function(e,t,n){return r(this,void 0,void 0,function(){var r,i;return a(this,function(a){switch(a.label){case 0:return r=s.default.dump(n),i=u.default.resolve(e,t),[4,o.default.writeFile(i,r)];case 1:return a.sent(),[2]}})})},e.prototype.findReference=function(e){var t=this.references.filter(function(t){return t.table===e});return t.length?t[0]:void 0},e}();t.Metadata=c},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(a,i){function o(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){e.done?a(e.value):new n(function(t){t(e.value)}).then(o,u)}s((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=i(n(0)),u=i(n(2)),s=i(n(3)),c=n(7),l=n(6),f=function(){function e(e,t){this.name=e,this.items=t}return e.prototype.save=function(e){return r(this,void 0,void 0,function(){var t,n,r;return a(this,function(a){switch(a.label){case 0:return t=s.default.dump(this.items),n=this.name+".yaml",r=u.default.resolve(e,n),[4,o.default.writeFile(r,t)];case 1:return a.sent(),[2]}})})},Object.defineProperty(e.prototype,"length",{get:function(){return this.items.length},enumerable:!0,configurable:!0}),e}();t.Table=f,t.makeTable=function(e,t){var n=t[0],r=l.makeAttributes(n),a=t.slice(1).map(function(e){return c.makeRecord(r,e)}).map(function(e){return e.value});return new f(e,a)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t){this.attr=e,this.data=t}return Object.defineProperty(e.prototype,"value",{get:function(){return this.attr.cast(this.data)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"key",{get:function(){return this.attr.name},enumerable:!0,configurable:!0}),e}();t.Cell=r},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(a,i){function o(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){e.done?a(e.value):new n(function(t){t(e.value)}).then(o,u)}s((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},o=this;Object.defineProperty(t,"__esModule",{value:!0});var u=i(n(0)),s=i(n(2)),c=i(n(3)),l=n(1),f=function(e,t,n){return r(o,void 0,void 0,function(){var r,i,o;return a(this,function(a){switch(a.label){case 0:return r=function(e,t,n){var r=s.default.resolve(e,t);return s.default.resolve(r,n)}(e,t,n),[4,u.default.readFile(r)];case 1:return i=a.sent(),o=i.toString("utf8"),[2,c.default.load(o)]}})})};t.findSheetNames=function(e,t){return r(o,void 0,void 0,function(){var n;return a(this,function(r){switch(r.label){case 0:return n=s.default.resolve(e,t),[4,u.default.readdir(n)];case 1:return[2,r.sent().sort().filter(function(e){return e.includes(".yaml")}).filter(function(e){return!e.startsWith("metadata-")}).map(function(e){return e.replace(".yaml","")})]}})})},t.loadTable=function(e,t,n){return r(o,void 0,void 0,function(){var r,i;return a(this,function(a){switch(a.label){case 0:if(n.startsWith("metadata-"))return[2,new l.Table(n,[])];a.label=1;case 1:return a.trys.push([1,3,,4]),[4,f(e,t,n+".yaml")];case 2:return r=a.sent(),[2,new l.Table(n,r)];case 3:return i=a.sent(),console.error(i),[2,new l.Table(n,[])];case 4:return[2]}})})},t.loadMetadata=function(e,t){return r(o,void 0,void 0,function(){var n,i,o,u,s=this;return a(this,function(c){switch(c.label){case 0:return n=function(){return r(s,void 0,void 0,function(){return a(this,function(n){switch(n.label){case 0:return"metadata-constraints.yaml",[4,f(e,t,"metadata-constraints.yaml")];case 1:return[2,n.sent()]}})})},i=function(){return r(s,void 0,void 0,function(){return a(this,function(n){switch(n.label){case 0:return"metadata-references.yaml",[4,f(e,t,"metadata-references.yaml")];case 1:return[2,n.sent()]}})})},o=l.Metadata.bind,[4,i()];case 1:return u=[void 0,c.sent()],[4,n()];case 2:return[2,new(o.apply(l.Metadata,u.concat([c.sent()])))]}})})}},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(a,i){function o(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){e.done?a(e.value):new n(function(t){t(e.value)}).then(o,u)}s((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t};Object.defineProperty(t,"__esModule",{value:!0});var o=n(1),u=i(n(4)),s=function(e){return"nadeshiko:"+e},c=function(){function e(e){this.redis=e}return e.prototype.mset=function(e,t){return r(this,void 0,void 0,function(){var n,r,i;return a(this,function(a){switch(a.label){case 0:return 0===t.length?[2]:(r=s(e),i=u.flatten(t.map(function(e){return[e.id.toString(),JSON.stringify(e)]})),[4,(n=this.redis).hmset.apply(n,[r].concat(i))]);case 1:return a.sent(),[2]}})})},e.prototype.mget=function(e){return r(this,void 0,void 0,function(){var t,n,r;return a(this,function(a){switch(a.label){case 0:return t=s(e),[4,this.redis.hgetall(t)];case 1:return n=a.sent(),r=u.values(n),[2,r.map(function(e){return{val:JSON.parse(e)}}).sort(function(e,t){return e.val.id-t.val.id}).map(function(e){return e.val})]}})})},e.prototype.get=function(e,t){return r(this,void 0,void 0,function(){var n,r,i;return a(this,function(a){switch(a.label){case 0:return n=s(e),r=t.toString(),[4,this.redis.hget(n,r)];case 1:return[2,(i=a.sent())?JSON.parse(i):void 0]}})})},e.prototype.saveTable=function(e){return r(this,void 0,void 0,function(){var t,n,r;return a(this,function(a){switch(a.label){case 0:return t=e.name,n=e.items,r=s(t),[4,this.redis.del(r)];case 1:return a.sent(),[4,this.mset(t,n)];case 2:return a.sent(),[2]}})})},e.prototype.loadTable=function(e){return r(this,void 0,void 0,function(){var t;return a(this,function(n){switch(n.label){case 0:return[4,this.mget(e)];case 1:return t=n.sent(),[2,new o.Table(e,t)]}})})},e.prototype.saveMetadata=function(e){return r(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,this.redis.mset("nadeshiko:references",JSON.stringify(e.references),"nadeshiko:constraints",JSON.stringify(e.constraints))];case 1:return t.sent(),[2]}})})},e.prototype.loadMetadata=function(){return r(this,void 0,void 0,function(){var e,t,n,r;return a(this,function(a){switch(a.label){case 0:return[4,this.redis.get("nadeshiko:references")];case 1:return e=a.sent(),[4,this.redis.get("nadeshiko:constraints")];case 2:return t=a.sent(),e&&t?(n=JSON.parse(e),r=JSON.parse(t),[2,new o.Metadata(n,r)]):[2,new o.Metadata([],[])]}})})},e}();t.TableCache=c},function(e,t,n){"use strict";var r=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(a,i){function o(e){try{s(r.next(e))}catch(e){i(e)}}function u(e){try{s(r.throw(e))}catch(e){i(e)}}function s(e){e.done?a(e.value):new n(function(t){t(e.value)}).then(o,u)}s((r=r.apply(e,t||[])).next())})},a=this&&this.__generator||function(e,t){var n,r,a,i,o={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return i={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function u(i){return function(u){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(a=2&i[0]?r.return:i[0]?r.throw||((a=r.return)&&a.call(r),0):r.next)&&!(a=a.call(r,i[1])).done)return a;switch(r=0,a&&(i=[2&i[0],a.value]),i[0]){case 0:case 1:a=i;break;case 4:return o.label++,{value:i[1],done:!1};case 5:o.label++,r=i[1],i=[0];continue;case 7:i=o.ops.pop(),o.trys.pop();continue;default:if(!(a=(a=o.trys).length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){o=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){o.label=i[1];break}if(6===i[0]&&o.label<a[1]){o.label=a[1],a=i;break}if(a&&o.label<a[2]){o.label=a[2],o.ops.push(i);break}a[2]&&o.ops.pop(),o.trys.pop();continue}i=t.call(e,o)}catch(e){i=[6,e],r=0}finally{n=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,u])}}},i=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n in e)Object.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t.default=e,t},o=this;Object.defineProperty(t,"__esModule",{value:!0});var u=n(26),s=n(1),c=i(n(4)),l=function(){function e(e,t){this.auth=e,this.metadataSheetId=t}return e.prototype.fetchReferences=function(){return r(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return e={table:"metadata-references",range:"A2:C",sheet:this.metadataSheetId},[4,this.fetchSheets([e])];case 1:return[2,t.sent()[0].values]}})})},e.prototype.fetchConstraints=function(){return r(this,void 0,void 0,function(){var e;return a(this,function(t){switch(t.label){case 0:return e={table:"metadata-constraints",range:"A2:E",sheet:this.metadataSheetId},[4,this.fetchSheets([e])];case 1:return[2,t.sent()[0].values]}})})},e.prototype.fetchSheets=function(e){return r(this,void 0,void 0,function(){var t,n,i,o,u,s=this;return a(this,function(l){switch(l.label){case 0:return t=c.groupBy(e,function(e){return e.table}),n=c.keys(t),i=n.map(function(e){return r(s,void 0,void 0,function(){var n,r;return a(this,function(a){switch(a.label){case 0:return n=t[e],r=n[0].sheet,[4,this.fetch(r,n)];case 1:return[2,a.sent()]}})})}),u=(o=c).flatten,[4,Promise.all(i)];case 1:return[2,u.apply(o,[l.sent()])]}})})},e.prototype.fetch=function(e,t){return r(this,void 0,void 0,function(){var n,r;return a(this,function(a){switch(a.label){case 0:return n=t.map(function(e){return s.toDataRange(e)}),[4,u.google.sheets({version:"v4",auth:this.auth}).spreadsheets.values.batchGet({spreadsheetId:e,ranges:n})];case 1:if(200!==(r=a.sent()).status)throw new Error("batchGet failed: "+r.statusText);if(!r.data.valueRanges)throw new Error("no values found");return[2,r.data.valueRanges.map(function(e){var t=s.sanitizeRange(e.range);return{name:s.getTableName(t),values:e.values}})]}})})},e}();t.GSheetDataSource=l,t.getJWTClient=function(e){return r(o,void 0,void 0,function(){var t;return a(this,function(n){return t=new u.google.auth.JWT(e.client_email,void 0,e.private_key,["https://www.googleapis.com/auth/spreadsheets"]),[2,new Promise(function(e,n){t.authorize(function(r,a){r?n(r):e(t)})})]})})}},function(e,t){e.exports=require("googleapis")}])});
//# sourceMappingURL=main.js.map